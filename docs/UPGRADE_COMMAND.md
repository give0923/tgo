# Upgrade Command 使用指南

## 概述

`./tgo.sh upgrade` 命令提供智能的服务升级功能，能够记住您在安装时使用的参数（`--cn` 和 `--source`），并在升级时自动应用这些参数。

## 核心特性

### 1. 参数持久化

当您执行 `./tgo.sh install` 时，脚本会自动保存您使用的部署模式：

- **配置文件位置**：`./data/.tgo-install-mode`
- **保存的参数**：
  - `USE_SOURCE`：是否使用源码构建模式
  - `USE_CN`：是否使用中国镜像源

### 2. 智能参数记忆

升级时，脚本会：
1. 检查是否提供了命令行参数
2. 如果提供了参数，使用用户提供的参数并更新配置
3. 如果没有提供参数，从配置文件读取之前保存的参数
4. 如果配置文件不存在，使用默认值（Image 模式，GHCR 镜像源）

## 使用场景

### 场景 1: 使用中国镜像源

```bash
# 首次安装
./tgo.sh install --cn

# 配置文件内容：
# USE_SOURCE=false
# USE_CN=true

# 后续升级（自动使用 --cn）
./tgo.sh upgrade

# 输出：
# [INFO] Loading saved install mode configuration...
# [INFO] Upgrade mode: IMAGE (pulling from Alibaba Cloud ACR)
```

### 场景 2: 使用源码构建

```bash
# 首次安装
./tgo.sh install --source

# 配置文件内容：
# USE_SOURCE=true
# USE_CN=false

# 后续升级（自动使用 --source）
./tgo.sh upgrade

# 输出：
# [INFO] Loading saved install mode configuration...
# [INFO] Upgrade mode: SOURCE (building from local repos)
# [INFO] Step 1/5: Pulling latest code from git...
```

### 场景 3: 同时使用两个参数

```bash
# 首次安装
./tgo.sh install --cn --source

# 配置文件内容：
# USE_SOURCE=true
# USE_CN=true

# 后续升级（自动使用 --cn --source）
./tgo.sh upgrade

# 输出：
# [INFO] Upgrade mode: SOURCE (building from local repos)
# [INFO] Using Gitee mirrors for git operations
```

### 场景 4: 覆盖保存的参数

```bash
# 首次安装使用 --cn
./tgo.sh install --cn

# 升级时切换到源码模式
./tgo.sh upgrade --source

# 输出：
# [INFO] Using user-provided parameters for upgrade
# [INFO] Saved install mode to ./data/.tgo-install-mode
# [INFO] Upgrade mode: SOURCE (building from local repos)

# 配置文件已更新为：
# USE_SOURCE=true
# USE_CN=false
```

## 升级流程

### Image 模式升级流程

当使用 Image 模式（默认）时，升级流程如下：

```
1. 拉取最新镜像
   ├─ 如果 --cn：从阿里云 ACR 拉取
   └─ 如果非 --cn：从 GHCR 拉取

2. 停止当前服务
   └─ docker compose down

3. 启动基础设施服务
   └─ postgres, redis, kafka, wukongim

4. 运行数据库迁移
   ├─ tgo-rag: alembic upgrade head
   ├─ tgo-ai: alembic upgrade head
   ├─ tgo-api: alembic upgrade head
   └─ tgo-platform: alembic upgrade head

5. 启动所有服务
   └─ docker compose up -d
```

### Source 模式升级流程

当使用 Source 模式（`--source`）时，升级流程如下：

```
1. 拉取最新代码
   ├─ git pull
   └─ git submodule update --init --recursive

2. 重新构建镜像
   └─ docker compose build

3. 停止当前服务
   └─ docker compose down

4. 启动基础设施服务
   └─ postgres, redis, kafka, wukongim

5. 运行数据库迁移
   ├─ tgo-rag: alembic upgrade head
   ├─ tgo-ai: alembic upgrade head
   ├─ tgo-api: alembic upgrade head
   └─ tgo-platform: alembic upgrade head

6. 启动所有服务
   └─ docker compose up -d
```

## 命令参数

```bash
./tgo.sh upgrade [--source] [--cn]
```

### 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--source` | 从本地源码构建镜像 | 从配置文件读取 |
| `--cn` | 使用中国镜像源（阿里云 ACR / Gitee） | 从配置文件读取 |

### 参数优先级

1. **命令行参数**（最高优先级）
2. **配置文件**（`./data/.tgo-install-mode`）
3. **默认值**（Image 模式，GHCR 镜像源）

## 配置文件格式

配置文件位于 `./data/.tgo-install-mode`，格式如下：

```bash
# TGO Install Mode Configuration
# Auto-generated by ./tgo.sh install
# This file is used by ./tgo.sh upgrade to remember your deployment preferences

USE_SOURCE=false
USE_CN=true
```

### 字段说明

- `USE_SOURCE`：`true` 表示源码构建模式，`false` 表示镜像模式
- `USE_CN`：`true` 表示使用中国镜像源，`false` 表示使用国际镜像源

## 常见问题

### Q1: 配置文件在哪里？

**A**: 配置文件位于 `./data/.tgo-install-mode`。这个目录已经在 `.gitignore` 中，不会被提交到 Git。

### Q2: 如果配置文件丢失了怎么办？

**A**: 如果配置文件不存在，`upgrade` 命令会：
1. 显示警告信息
2. 使用默认值（Image 模式，GHCR 镜像源）
3. 继续执行升级

您也可以手动指定参数：
```bash
./tgo.sh upgrade --cn --source
```

### Q3: 如何查看当前保存的配置？

**A**: 查看配置文件内容：
```bash
cat ./data/.tgo-install-mode
```

### Q4: 如何重置配置？

**A**: 删除配置文件并重新安装：
```bash
rm ./data/.tgo-install-mode
./tgo.sh install --cn  # 使用新的参数
```

### Q5: upgrade 和 install 有什么区别？

**A**: 主要区别：

| 特性 | install | upgrade |
|------|---------|---------|
| 数据目录创建 | ✅ 创建并设置权限 | ❌ 不处理 |
| 环境文件检查 | ✅ 复制 .env.example | ✅ 检查存在性 |
| 参数记忆 | ✅ 保存参数 | ✅ 读取/更新参数 |
| 代码更新 | ❌ 不更新 | ✅ git pull（source 模式） |
| 镜像更新 | ❌ 不拉取 | ✅ docker pull（image 模式） |

### Q6: 升级会丢失数据吗？

**A**: 不会。升级过程：
- ✅ 保留所有数据（`./data` 目录不受影响）
- ✅ 保留环境配置（`.env` 和 `envs/` 不受影响）
- ✅ 只更新代码和镜像
- ✅ 自动运行数据库迁移

### Q7: 升级失败了怎么办？

**A**: 如果升级失败：

1. **查看错误日志**：
   ```bash
   docker compose logs -f <service-name>
   ```

2. **回滚到之前的版本**（Image 模式）：
   ```bash
   # 停止服务
   docker compose down

   # 拉取特定版本的镜像
   docker pull ghcr.io/tgoai/tgo-deploy/tgo-api:v1.0.0

   # 启动服务
   docker compose up -d
   ```

3. **回滚到之前的版本**（Source 模式）：
   ```bash
   # 回退代码
   git reset --hard <previous-commit>
   git submodule update --init --recursive

   # 重新构建和启动
   ./tgo.sh build --source all
   ```

## 最佳实践

### 1. 定期升级

建议定期检查更新并升级：

```bash
# 每周或每月执行一次
./tgo.sh upgrade
```

### 2. 升级前备份

虽然升级不会丢失数据，但建议在重要升级前备份：

```bash
# 备份数据目录
tar -czf tgo-data-backup-$(date +%Y%m%d).tar.gz ./data

# 备份环境配置
tar -czf tgo-env-backup-$(date +%Y%m%d).tar.gz .env envs/

# 执行升级
./tgo.sh upgrade
```

### 3. 查看更新日志

升级前查看更新内容：

```bash
# Image 模式：查看 GitHub Releases
# https://github.com/tgoai/tgo-deploy/releases

# Source 模式：查看 git log
git fetch
git log HEAD..origin/main
```

### 4. 测试环境先升级

如果有测试环境，建议先在测试环境升级：

```bash
# 测试环境
cd /path/to/test-environment
./tgo.sh upgrade

# 验证功能正常后，再升级生产环境
cd /path/to/production
./tgo.sh upgrade
```

### 5. 监控升级过程

升级时监控服务状态：

```bash
# 在另一个终端窗口监控
watch -n 2 'docker compose ps'

# 或查看实时日志
docker compose logs -f
```

## 技术细节

### 配置文件生成

`save_install_mode()` 函数在 `install` 命令执行时被调用：

```bash
save_install_mode() {
  local mode="$1"
  local use_cn="$2"

  mkdir -p "$(dirname "$CONFIG_FILE")"

  cat > "$CONFIG_FILE" << EOF
# TGO Install Mode Configuration
USE_SOURCE=$( [ "$mode" = "source" ] && echo "true" || echo "false" )
USE_CN=$( [ "$use_cn" = "true" ] && echo "true" || echo "false" )
EOF
}
```

### 配置文件读取

`load_install_mode()` 函数在 `upgrade` 命令执行时被调用：

```bash
load_install_mode() {
  if [ ! -f "$CONFIG_FILE" ]; then
    echo "[WARN] No saved install mode found"
    echo "false false"  # 默认值
    return
  fi

  source "$CONFIG_FILE"

  local mode="image"
  [ "${USE_SOURCE:-false}" = "true" ] && mode="source"

  local cn_flag="false"
  [ "${USE_CN:-false}" = "true" ] && cn_flag="true"

  echo "$mode $cn_flag"
}
```

### 参数优先级实现

```bash
cmd_upgrade() {
  local user_provided_args=false

  # 解析命令行参数
  while [ "$#" -gt 0 ]; do
    case "$1" in
      --source|--cn)
        user_provided_args=true
        # ... 处理参数
        ;;
    esac
  done

  # 决定使用哪个参数源
  if [ "$user_provided_args" = true ]; then
    # 使用命令行参数
    save_install_mode "$mode" "$use_cn"  # 更新配置
  else
    # 读取保存的配置
    read -r mode use_cn <<< "$(load_install_mode)"
  fi
}
```

## 示例输出

### Image 模式升级（使用 CN 镜像）

```
$ ./tgo.sh upgrade

[INFO] Loading saved install mode configuration...
[INFO] Upgrade mode: IMAGE (pulling from Alibaba Cloud ACR)

=========================================
  IMAGE MODE UPGRADE
=========================================

[INFO] Step 1/5: Pulling latest Docker images...
[INFO] Pulling from Alibaba Cloud ACR...
[+] Pulling 6/6
 ✔ tgo-api Pulled
 ✔ tgo-rag Pulled
 ✔ tgo-ai Pulled
 ✔ tgo-platform Pulled
 ✔ tgo-web Pulled
 ✔ tgo-widget-app Pulled

[INFO] Step 2/5: Stopping current services...
[+] Running 10/10
 ✔ Container tgo-api Removed
 ✔ Container tgo-rag Removed
 ...

[INFO] Step 3/5: Starting infrastructure services...
[+] Running 4/4
 ✔ Container tgo-postgres Started
 ✔ Container tgo-redis Started
 ✔ Container tgo-kafka Started
 ✔ Container tgo-wukongim Started

[INFO] Waiting for Postgres to be ready...
Postgres is ready!

[INFO] Step 4/5: Running database migrations...
INFO  [alembic.runtime.migration] Running upgrade -> abc123
...

[INFO] Step 5/5: Starting all services...
[+] Running 10/10
 ✔ Container tgo-api Started
 ✔ Container tgo-rag Started
 ...

=========================================
  ✅ UPGRADE COMPLETE
=========================================

Upgrade summary:
  • Mode: IMAGE (pulled from registry)
  • Registry: Alibaba Cloud ACR (China)
  • Configuration saved to: ./data/.tgo-install-mode

Use 'docker compose ps' to check service status.
```

### Source 模式升级

```
$ ./tgo.sh upgrade

[INFO] Loading saved install mode configuration...
[INFO] Upgrade mode: SOURCE (building from local repos)

=========================================
  SOURCE MODE UPGRADE
=========================================

[INFO] Step 1/5: Pulling latest code from git...
From https://github.com/tgoai/tgo
 * branch            main       -> FETCH_HEAD
Already up to date.

[INFO] Updating git submodules...
Submodule path 'repos/tgo-api': checked out 'abc123'
...

[INFO] Step 2/5: Rebuilding Docker images from source...
[+] Building 45.2s (25/25) FINISHED
 => [tgo-api internal] load build definition
 => [tgo-api] building...
 ...

[INFO] Step 3/5: Stopping current services...
...

[INFO] Step 4/5: Starting services with new images...
...

[INFO] Step 5/5: Running database migrations...
...

=========================================
  ✅ UPGRADE COMPLETE
=========================================

Upgrade summary:
  • Mode: SOURCE (built from local code)
  • Registry: GitHub Container Registry
  • Configuration saved to: ./data/.tgo-install-mode
```

## 相关命令

- `./tgo.sh install` - 首次部署（会保存配置）
- `./tgo.sh build --source <service>` - 重新构建特定服务
- `./tgo.sh service start` - 启动服务（不升级）
- `./tgo.sh service stop` - 停止服务
- `./tgo.sh uninstall` - 卸载服务

---

**文档版本**: 1.0
**最后更新**: 2024-11-21
**相关文件**: `tgo.sh`, `./data/.tgo-install-mode`


